# SPDX-FileCopyrightText: 2026 RVLab Contributors
# SPDX-License-Identifier: Apache-2.0

name: Verilator Flow Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verilator-flow:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Verilator
      uses: kreijstal/install-verilator-action@main
        
    - name: Install RISC-V GCC multilib toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-riscv64-unknown-elf \
          make \
          git \
          perl
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Initialize XilinxUnisimLibrary submodule
      run: |
        git submodule update --init --recursive vendor/XilinxUnisimLibrary

    - name: Run Verilator module testbench
      run: |
        flow student_rlight_tb.sim_rtl_verilator
        test -f build/student_rlight_tb/sim_rtl_verilator/trace.vcd
        
    - name: Run Verilator system testbench
      run: |
        flow systb_test_rvlab.sim_rtl_verilator
        test -f build/systb_test_rvlab/sim_rtl_verilator/trace.vcd
